# 13장 지속적 통합

소프트웨어 엔트로피: 소프트웨어가 시간이 지남에 따라 점점 더 복잡해지고, 유지보수하기 어려워지는 현상

소프트웨어 엔트로피 증가를 막을 방법은 없을까?

이에 대한 최선의 대안은 지속적 전달이다. 이 용어는 '가치있는 소프트웨어의 빠르고 지속적인 전달'을 통해 고객 만족을 최우선으로 하는 애자일 소프트웨어 개발 방법론의 일부로 등장했다.

이보다 10년 앞선 용어로 '지속적 통합'이라는 용어가 있다. 한 명 이상의 개발자로 구성된 팀에서 믿을 수 있는 코드 통합은 더욱 중요하며 자주 수행되어야 한다.

지속적 통합이 존재하려면 반드시 자동화된 테스트가 필요하다. 그렇지 않으면 새로운 코드가 통합되었을 때 어떤 코드가 통합되었는지, 그 코드가 시스템에 어떤 영향을 미칠지 알 수 없다.

이번 장에서는 이제까지 작성한 단위 테스트를 지속적 통합 프로세스의 일부로 자동화하는 방법을 살펴본다.

## 핵심 개념

지속적 통합은 지속적 배포로 발전, 지속적 전달로 이어지는 소프트웨어 성숙도 연속체의 첫 단계이다.

### 버전 관리

지속적 통합을 위해서는 소프트웨어 빌드에 필요한 모든 소스 코드와 설정 파일을 버전 관리 시스템에 저장해야 한다.

버전 관리 시스템은 다음과 같은 기능을 제공한다.

1. 임의의 구조와 깊이에 파일 및 폴더의 현재 상태를 저장
2. 파일과 폴더를 하나의 통합된 저장소에 저장
3. 삭제, 이름 변경, 이동, 수정 등의 변경 내용을 추적
4. 모든 파일 및 폴더의 모든 리비전을 시간 순서대로 추적할 수 있도록 버전을 생성 및 관리
5. 변경사항을 저장소에 반영(커밋)하고, 저장소의 변경사항을 로컬로 가져오기(체크아웃) 및 병합(마스터 브랜치와 통합) 가능

깃(Git)은 가장 널리 사용되는 버전 관리 시스템 중 하나이다. 깃은 빠르고 효율적인 분산 버전 관리 시스템으로, 소스 코드의 변경 내용을 추적하고, 변경 내용을 저장하고, 변경 내용을 다른 개발자와 공유할 수 있다.

CI를 활성화하기 위해, 모든 개발자가 접속하는 중앙집중식 깃 서버를 갖추는 것이 훨씬 일반적이다. 대표적인 깃 서버로는 깃허브(GitHub), 깃랩(GitLab), 비트버킷(Bitbucket) 등이 있다.

### 빌드 서버 및 에이전트

빌드 자동화는 여러 단계로 이루어진다.

1. 빌드 서버는 정기적으로 VCS를 모니터링하고, 변경 사항을 감지한다.
2. 빌드 서버는 변경 사항을 감지하면 빌드 에이전트에게 빌드를 실행하도록 지시한다.
3. 서로 다른 운영체제에서 실행하거나 다른 의존성 세트로 빌드하기 위해 다수의 빌드 에이전트 프로세스가 있기도 하다.

이 장에서는 깃허브 액션(GitHub Actions)에서 제공하는 빌드 서버와 에이전트를 사용한다.

필요한 빌드 서버와 설치해야 할 항목을 나타내기 위해 선언형 구성 파일을 사용한다. 빌드 에이전트는 서로 독립적으로 실행되며, 빌드 서버와 통신하여 빌드를 실행한다.

빌드 에이전트가 서로 독립적인데 어떻게 빌드 산출물을 공유할 수 있을까? 여기에 아티팩트 저장소가 등장한다.

### 아티팩트 저장소

아티팩트 저장소는 빌드 산출물을 저장하는 곳이다. 원칙적으로, 아티팩트 저장소는 에이전트가 접근할 수 있는 공유 파일 시스템이다.

아티팩트 저장소는 파일 및 폴더의 저장, 버전 관리, 검색, 다운로드, 삭제 등의 기능을 제공한다. 얼핏 보면 버전 관리 시스템과 유사해 보이지만, 아티팩트 저장소는 빌드 산출물을 저장하는 데 초점을 맞추어 설계되었다.

우리는 서로 다른 빌드 간 공유할 아티팩트가 없기 때문에 아티팩트 저장소를 사용하지 않는다. 그렇지만 깃허브는 소스 코드를 저장하는 같은 코드 저장소에 빌드 산출물을 저장할 수 있도록 지원한다.

### 배포 환경

성공적으로 생성된 빌드 아티팩트는 배포 환경에서 실행되어야 한다. 이는 아티팩트가 실제로 사용자에게 제공되는 방식을 의미한다.

그러나 이 책에서는 배포 환경을 다루지 않는다. 지속적 통합은 빌드 및 테스트 단계에만 초점을 맞추기 때문이다.

## 모두 합치기

깃허브 액션을 사용하여 지속적 통합을 활성화하는 방법을 살펴보자.

다음은 우리 코드에 CI 파이프라인을 구축하는 단계다.

1. 깃허브 계정 생성 및 검증
2. 깃허브에 신규 프로젝트 생성
3. 코드 저장소를 깃허브에 푸시
4. CI 빌드 스크립트에 대한 소스 코드 준비
5. CI 빌드 스크립트 생성
6. 깃허브에 빌드 스크립트 푸시

### 깃허브 계정 생성 및 검증

이 부분은 생략한다.

### 코드 저장소를 깃허브에 푸시

이 부분은 생략한다.

### CI 빌드 스크립트 준비

현재 디렉터리 구조는 다음과 같다.

```bash
$ tree .
.
├── README.md
└── go
    ├── go.mod
    ├── money_test.go
    └── stocks
        ├── bank.go
        ├── money.go
        └── portfolio.go

2 directories, 6 files
```

CI 빌드 스크립트는 신규 디렉터리 `.github/workflows`에 저장된다.

```bash
$ mkdir -p .github/workflows
```

이제 `.github/workflows` 디렉터리에 `ci.yml` 파일을 생성한다.

```bash
$ touch .github/workflows/ci.yml
```

이제 `ci.yml` 파일을 열고 다음 내용을 추가한다.

```yaml
name: Go CI #1
on:
  push:
    branches: [chapter13] #2
jobs:
  build:
    name: Build #3
    strategy:
      matrix: #4
        go-version: [1.23.x, 1.22.x]
        platform: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }} #5
    steps: #6
      - name: Set up Go ${{ matrix.go-version }} #7
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}
      - name: Check out code #8
        uses: actions/checkout@v4
      - name: Test #9
        run: |
          cd go
          go test -v ./...

#10
```

이 파일은 다음과 같은 작업을 수행한다.

1. 전체 스크립트에 대한 이름을 `Go CI`로 지정한다.
2. `chapter13` 브랜치에 푸시할 때마다 실행되도록 설정한다.
3. `Build` 작업을 정의한다.
4. 매트릭스 빌드 전략(matrix build strategy)을 정의한다. 이는 여러 플랫폼에서 빌드를 실행할 수 있도록 한다.
5. `ubuntu-latest`, `macos-latest`, `windows-latest` 플랫폼에서 빌드를 실행한다.
6. 빌드 단계를 정의한다.
7. `actions/setup-go@v4` 액션을 사용하여 Go 환경을 설정한다.
8. `actions/checkout@v4` 액션을 사용하여 코드를 체크아웃(지정된 브랜치에서 코드를 가져옴)한다.
9. `go test -v ./...` 명령을 실행하여 테스트를 실행한다.
10. 각 단계가 성공적으로 실행되고 나면, 역순으로 클린업을 수행한다.

매트릭스 빌드 전략을 사용하면 여러 플랫폼에서 여러 버전의 Go를 사용하여 빌드를 실행할 수 있다. 상기 예제에서는 `1.23.x`, `1.22.x` 버전의 Go를 사용하며, `ubuntu-latest`, `macos-latest`, `windows-latest` 플랫폼에서 빌드를 실행한다. 즉, 총 6개의 빌드가 실행된다.

## 변경 사항 반영하기

이제 변경 사항을 반영하고 깃허브에 푸시한다.

```bash
$ git add .
$ git commit -m "feat: continuous integration script using Github Actions"
$ git push origin chapter13
```

변경 사항이 깃허브에 푸시되면, 깃허브 액션에서 CI 파이프라인이 실행된다.

## 중간 점검

성공적으로 지속적 통합을 활성화했다. 다음은 그동안 배운 내용에 대한 리뷰가 이어진다.
